{% extends "base.html" %}

{% block title %}Column Mapping - Fox Hardware Inventory{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-slate-100">Column Mapping</h1>
        <p class="mt-2 text-sm text-slate-400">Map your Excel columns to asset fields</p>
    </div>

    <div class="bg-slate-800 rounded-lg border border-slate-700 p-6 mb-6">
        <div class="mb-4">
            <p class="text-sm text-slate-300"><strong>File:</strong> {{ filename }}</p>
            <p class="text-sm text-slate-300"><strong>Rows:</strong> {{ row_count }}</p>
        </div>

        <form id="mapping-form">
            <input type="hidden" name="file_path" value="{{ file_path }}">
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-700">
                    <thead class="bg-slate-700">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase">Target Field</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase">Source Column</th>
                        </tr>
                    </thead>
                    <tbody class="bg-slate-800 divide-y divide-slate-700">
                        {% for field in ['asset_tag', 'computer_name', 'department', 'assigned_user_name', 'assigned_user_id', 'operating_system', 'serial_number', 'status', 'notes'] %}
                        <tr>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-200">
                                {{ field.replace('_', ' ').title() }}
                                {% if field == 'asset_tag' %}<span class="text-red-400">*</span>{% endif %}
                            </td>
                            <td class="px-4 py-3">
                                <select name="mapping_{{ field }}" 
                                        class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- None --</option>
                                    {% for col in columns %}
                                    <option value="{{ col }}" {% if auto_mapping.get(field) == col %}selected{% endif %}>
                                        {{ col }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mt-6 flex justify-end space-x-4">
                <a href="/import" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-100 rounded-lg">
                    Cancel
                </a>
                <button type="button" onclick="submitMapping()"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">
                    Preview Import
                </button>
            </div>
        </form>
    </div>

    <!-- Sample Data Preview -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
        <h2 class="text-lg font-semibold text-slate-100 mb-4">Sample Data</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-700">
                <thead class="bg-slate-700">
                    <tr>
                        {% for col in columns %}
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase">{{ col }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="bg-slate-800 divide-y divide-slate-700">
                    {% for row in sample_data %}
                    <tr>
                        {% for col in columns %}
                        <td class="px-4 py-3 text-sm text-slate-300">{{ row.get(col, '-') }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div id="preview-container"></div>
</div>

<script>
function submitMapping() {
    const form = document.getElementById('mapping-form');
    const formData = new FormData(form);
    const mapping = {};
    
    // Collect mapping data
    const fields = ['asset_tag', 'computer_name', 'department', 'assigned_user_name', 'assigned_user_id', 'operating_system', 'serial_number', 'status', 'notes'];
    fields.forEach(field => {
        const value = formData.get('mapping_' + field);
        if (value) {
            mapping[field] = value;
        }
    });
    
    // Create new form data with mapping JSON
    const submitData = new FormData();
    submitData.append('file_path', formData.get('file_path'));
    submitData.append('mapping_json', JSON.stringify(mapping));
    
    // Submit via HTMX
    htmx.ajax('POST', '/import/preview', {
        values: Object.fromEntries(submitData),
        target: '#preview-container',
        swap: 'innerHTML'
    });
}
</script>
{% endblock %}
